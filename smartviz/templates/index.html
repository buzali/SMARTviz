<!DOCTYPE html>
<html lang="en" ng-app="StarterApp">
	<head>
		<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/angular_material/0.8.2/angular-material.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
		<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	</head>
	<body ng-controller="AppCtrl" layout="column">
		{% verbatim %}
		<section layout="row" flex>
	    <md-sidenav class="md-sidenav-left md-whiteframe-z2" md-component-id="left" md-is-locked-open="true" flex="30">
	      <md-toolbar class="md-theme-indigo" style="min-height:148px;">
			<md-content md-theme="docs-dark" class="md-padding" style="min-height:48px;max-height:48;overflow: hidden;">
	        <ng-switch on="data.selectedScreen" class="tabpanel-container">
				<div role="tabpanel" ng-switch-when="0">
			        <center>1) Search your city</center>
			    </div>
				<div role="tabpanel" ng-switch-when="1">
			        <center>2) Select an event</center>
			    </div>
				<div role="tabpanel" ng-switch-when="2">
			        <a class="md-accent" ng-click="data.back()" style="margin-top:-2; margin-bottom:-3px;float:left;">
				        <i class="fa fa-chevron-left md-accent" style="font-size:.9em;"></i>
					</a>
			        <center>3) See what's going on nearby</center>
			    </div>
		    </ng-switch>
			</md-content>
			<md-divider></md-divider>
	        <h1 class="md-toolbar-tools" style="height:100px;max-height: 100px;">
		        
		        <md-content md-theme="docs-dark"  layout="column" layout-sm="column" style="font-size:1em;width:100%">
			    <md-input-container style="padding: 2px 2px 8px;" style="width:100%">
			      <label>City</label>
			      <input type="text" ng-autocomplete ng-model="result" details="details" options="options" placeholder=""/>
			    </md-input-container>
			  </md-content>
		        
	        </h1>
	        <!--<ng-switch on="data.selectedScreen" class="tabpanel-container">
				<div role="tabpanel" ng-switch-when="1">
			        <md-tabs md-selected="data.selectedIndex" style="background:white;min-height:48px;">
					    <md-tab ng-repeat="feed in events" label="{{feed.name}}" style="font-size:.9em;">
				    </md-tabs>
			    </div>
		    </ng-switch>-->
	      </md-toolbar>
	      <md-content ng-controller="LeftCtrl">
	        <ng-switch on="data.selectedScreen" class="tabpanel-container">
			<div role="tabpanel" ng-switch-when="1">
				<div layout="column" flex layout-fill>
					<div ng-repeat="feed in events">
					    <!--<div role="tabpanel" ng-if="$index == data.selectedIndex">
						    <div class="demo-tab feed{{$index%4}}" layout="column">-->
						    <md-subheader class="md-primary" style="border-bottom: 1px solid rgba(0,0,0,0.12);">{{feed.name}}</md-subheader>
						    	<md-list>
									<md-item ng-repeat="item in feed.data">
										<md-button ng-click="data.selectEvent(item)">
									        <md-item-content>
										        <div class="md-tile-content">
											        <h3><strong>{{item.name}}</strong></h3>
											        <p>{{item.address}}</p>
										        </div>
									        </md-item-content>
										</md-button>
									</md-item>
								</md-list>
						<!--    </div>
					    </div> -->
					</div>
	        	</div>
			</div>
			<div role="tabpanel" ng-switch-when="2">
				
					<md-content class="md-padding">
					    <h2>{{selected.name}}</h2>
						<p>{{selected.address}}</p>
					</md-content>
					<md-divider></md-divider>
			
			<md-tabs md-selected="selectedIndex" flex>
		    <md-tab label="Food">
			    <ng-switch on="places.loading" class="tabpanel-container">
					<div role="tabpanel" ng-switch-when="0">
						<div layout="row" layout-sm="column" layout-align="space-around" style="margin:50px;">
					      <md-progress-circular md-mode="indeterminate"></md-progress-circular>
					    </div>
				    </div>
					<div role="tabpanel" ng-switch-when="1" style="margin:50px;">
				        <center>We couldn't find any restaurants :(</center>
				    </div>
					<div role="tabpanel" ng-switch-when="2">
						<md-list class="md-padding">
							<md-item ng-repeat="item in places.data">
								<md-button ng-click="data.selectPlace(item)">
							        <md-item-content>
								        <div class="md-tile-content">
									        <h3><strong>{{item.name}}</strong></h3>
								        </div>
							        </md-item-content>
								</md-button>
							</md-item>
						</md-list>
				    </div>
			    </ng-switch>
		    </md-tab><md-tab label="Instagram">
			    <ng-switch on="instagram.loading" class="tabpanel-container">
					<div role="tabpanel" ng-switch-when="0">
						<div layout="row" layout-sm="column" layout-align="space-around" style="margin:50px;">
					      <md-progress-circular md-mode="indeterminate"></md-progress-circular>
					    </div>
				    </div>
					<div role="tabpanel" ng-switch-when="1" style="margin:50px;">
				        <center>We couldn't find any photos :(</center>
				    </div>
					<div role="tabpanel" ng-switch-when="2">
						<md-list class="md-padding">
							<md-item ng-repeat="item in instagram.data">
								<md-button ng-click="data.selectPlace(item)">
							        <md-item-content>
						          <div class="md-tile-left">
						              <div ng-style="{'background-image':'url('+item.photo+')'}" class="instaimage"></div>
						          </div>
								        <div class="md-tile-content">
									        <h3><strong>{{item.title}}</strong></h3>
											        <p>{{item.description}}</p>
								        </div>
							        </md-item-content>
								</md-button>
							</md-item>
						</md-list>
				    </div>
			    </ng-switch>
		    </md-tab>
		    <md-tab label="Twitter">
			    <ng-switch on="twitter.loading" class="tabpanel-container">
					<div role="tabpanel" ng-switch-when="0">
						<div layout="row" layout-sm="column" layout-align="space-around" style="margin:50px;">
					      <md-progress-circular md-mode="indeterminate"></md-progress-circular>
					    </div>
				    </div>
					<div role="tabpanel" ng-switch-when="1" style="margin:50px;">
				        <center>We couldn't find any tweets :(</center>
				    </div>
					<div role="tabpanel" ng-switch-when="2">
						<md-list class="md-padding">
							<md-item ng-repeat="item in twitter.data">
								<md-button>
						        <md-item-content>
						          <div class="md-tile-left">
						              <div ng-style="{'background-image':'url('+item.photo+')'}" class="image"></div>
						          </div>
							        <div class="md-tile-content">
								        <h3><strong>{{item.title}}</strong></h3>
								        <p>{{item.description}}</p>
							        </div>
						        </md-item-content>
								</md-button>
							</md-item>
						</md-list>
				    </div>
			    </ng-switch>
		    </md-tab>
		  </md-tabs>	
	        	
					
			</div>
	      </md-content>
	    </md-sidenav>
	    <md-content flex>
				<ui-gmap-google-map center='map.center' zoom='map.zoom'>
				 <ui-gmap-window show="map.window.show" coords="map.window.model" options="map.window.options" closeclick="map.window.closeClick()">
		            <div>{{map.window.model.name}}</div>
		        </ui-gmap-window>
					<ui-gmap-markers models="mapEvents" coords="'self'" icon="'icon'" events="map.markersEvents" doCluster="true">
					</ui-gmap-markers>
					<ui-gmap-markers models="foodEvents" coords="'self'" icon="'icon'" events="map.markersEvents"><!-- doCluster="true"> -->
					</ui-gmap-markers>
				</ui-gmap-google-map>
		</md-content>
		</section>
		{% endverbatim %}
		
		<!-- Angular Material Dependencies -->
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.6/angular-animate.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-aria.min.js"></script>
		<script src="static/lodash.min.js"></script>
		<script src="static/angular-google-maps.min.js"></script>
		<script src="static/ngAutocomplete.js"></script>
		
		<script src="//ajax.googleapis.com/ajax/libs/angular_material/0.8.2/angular-material.min.js"></script>
    
    
    	<script>
			angular.module('StarterApp', ['uiGmapgoogle-maps','ngMaterial','ngAutocomplete'])
			.controller('AppCtrl', function($scope, $timeout, $mdSidenav, $log, $http) {
			  
			  var oldcenter;
			  var oldmap;
			  
			  $scope.selected = {
				  name: "",
				  address: ""
			  }
			  
			  $scope.twitter = {loading: 0, data: []};
			  $scope.places = {loading: 0, data: []};
			  $scope.instagram = {loading: 0, data: []};
			  
			  $scope.data = {
			      selectedIndex : 0,
			      selectedScreen: 0,
			      selectPlace: function(item) {
	                  $scope.map.window.model = item;
	                  $scope.map.window.show = true;
					  $scope.map.center = { latitude: item.latitude, longitude: item.longitude };
			      },
			      selectEvent: function(item) {
				      $scope.data.selectedScreen = 2;
				      $scope.selected.name = item.name;
				      $scope.selected.address = item.address;
				      
	                  $scope.map.window.model = item;
	                  $scope.map.window.show = true;
	                  $scope.foodEvents = [];
				      
				      oldcenter = $scope.map.center;
				      oldmap = $scope.mapEvents;
					  $scope.map.center = { latitude: item.latitude, longitude: item.longitude };
				      $scope.map.zoom = 17;
				      $scope.mapEvents = [item];
				      $scope.twitter.loading = 0;
				      $scope.places.loading = 0;
				      $scope.instagram.loading = 0;
				      
				      var httpRequest = $http({
				            method: 'GET',
				            url: '/related/twitter/'+item.name,
				
				        }).success(function(data, status) {
					        $scope.twitter.data = data
					        if(data.length > 0)
					        	$scope.twitter.loading = 2;
					        else
								$scope.twitter.loading = 1;
				        });
				      
				      var httpRequest = $http({
				            method: 'GET',
				            url: '/related/places/'+item.latitude+"/"+item.longitude+"/food",
				
				        }).success(function(data, status) {
					        for (i = 0; i < data.length; i++) { 
							    data[i].id = i + 5000;
							}
					        $scope.places.data = data
							$scope.foodEvents = data;
					        if(data.length > 0)
					        	$scope.places.loading = 2;
					        else
								$scope.places.loading = 1;
				        });
				      
				      var httpRequest = $http({
				            method: 'GET',
				            url: '/related/instaloco/'+item.latitude+"/"+item.longitude,
				
				        }).success(function(data, status) {
					        $scope.instagram.data = data
					        if(data.length > 0)
					        	$scope.instagram.loading = 2;
					        else
								$scope.instagram.loading = 1;
				        });
			      },
			      back: function() {
				      $scope.data.selectedScreen = 1;
				      $scope.map.center = oldcenter;
					  $scope.map.zoom = 10;
					  $scope.mapEvents = oldmap;
	                  $scope.map.window.show = false;
			      }
			    };
			  
			  $scope.map = {
				  center: {
					  latitude: 37.09024,
					  longitude: -95.712891
				  },
				  markers: [], 
				  zoom: 4,
				  markersEvents: {
		            click: function(marker, eventName, model, arguments) {
		                $scope.map.window.model = model;
		                $scope.map.window.show = true;
		                
		                if ($scope.data.selectedScreen != 2)
		                	$scope.data.selectEvent(model);
		            }
		        },
		        window: {
		            marker: {},
		            show: false,
		            closeClick: function() {
		                this.show = false;
		            },
		            options: {pixelOffset: new google.maps.Size(0, -40)} 
		        }
			  };
			  $scope.events = [];
			  $scope.mapEvents = [];
			  $scope.city = "New York";
			  
			  $scope.result = '';
			  $scope.options = {
			      types: '(cities)'
			  };    
    		  $scope.details = '';
			  
	          $(".angular-google-map-container").height($(window).height());
		        
		        $scope.$watch("details", function(newValue, oldValue) {
				    if (newValue) {
				     	$scope.data.selectedScreen = 1;
						$scope.events = [];
					    
					    var lng = newValue.geometry.location.D;
					    var lat = newValue.geometry.location.k;
					    
						$scope.map.center = { latitude: lat, longitude: lng };
						$scope.map.zoom = 10;
			        
					    var httpRequest = $http({
				            method: 'GET',
				            url: '/events/foursquare/'+lat+','+lng,
				
				        }).success(function(data, status) {
					        for (i = 0; i < data.length; i++) { 
							    data[i].id = i + 1000;
							}
							if (data.length > 0) {
								if ($scope.data.selectedScreen == 2)
									oldmap = oldmap.concat(data);
								else
									$scope.mapEvents = $scope.mapEvents.concat(data);
					            $scope.events.push({name: "Foursquare", data: data});
				            }
				        });
			        
					    var httpRequest = $http({
				            method: 'GET',
				            url: '/events/meetups/'+lat+','+lng,
				
				        }).success(function(data, status) {
					        for (i = 0; i < data.length; i++) { 
							    data[i].id = i + 2000;
							}
							if (data.length > 0) {
								if ($scope.data.selectedScreen == 2)
									oldmap = oldmap.concat(data);
								else
									$scope.mapEvents = $scope.mapEvents.concat(data);
					            $scope.events.push({name: "Meetups", data: data});
					        }
				        });
			        
					    var httpRequest = $http({
				            method: 'GET',
				            url: '/events/songkick/'+lat+','+lng,
				
				        }).success(function(data, status) {
					        for (i = 0; i < data.length; i++) { 
							    data[i].id = i + 3000;
							}
							if (data.length > 0) {
								if ($scope.data.selectedScreen == 2)
									oldmap = oldmap.concat(data);
								else
									$scope.mapEvents = $scope.mapEvents.concat(data);
					            $scope.events.push({name: "Songkick", data: data});
				            }
				        });
			        }
				});
		        
			})
			.controller('LeftCtrl', function($scope, $timeout, $mdSidenav, $log) {
			  $scope.close = function() {
			    $mdSidenav('left').close()
			                      .then(function(){
			                        $log.debug("close LEFT is done");
			                      });
			  };
			});
			
		</script>
		<style>
		
			.md-tile-left div.image,.md-tile-left div.instaimage {
				border-radius: 30px;
				border: 1px solid #ddd;
				background-color: #eee;
				width: 48px;
				height:48px;
				background-size:cover;
				margin: 16px; }
			.md-tile-left div.instaimage {
				width:148px;
				height:148px;
				border-radius: 5px;
			}
			.angular-google-map-container { height: 100px; width:100%; }
			md-input-container.md-docs-dark-theme .md-input {
				color: rgba(255,255,255,1.0);
				border-color: rgba(255,255,255,0.12);
			}
			
			md-item .md-button {
				text-align: left;
				width:100%;
				white-space: normal;
				padding:0;
				text-transform: none;
				font-weight: inherit;
				
			}
			
			input::-webkit-input-placeholder { color:transparent; }
			input::-moz-placeholder { color:transparent; } /* FF 4-18 */
			input::-moz-placeholder { color:transparent; } /* FF 19+ */
			input::-ms-input-placeholder { color:transparent; } /* IE 10+ */
							
		</style>
	</body>
</html>